# Assignment 102: Change Your Lucky Number

In Module 100, you minted your PPBL 2024 token. At the moment you minted the token, **two** tokens were minted. One token was sent to your wallet, and one token was sent to this validator address: `addr_test1wq93thc87gxalhkjjhu5003d94xshx94t08hnlmp2x675mctnrx8v`.

Both tokens have the same policy id. The policy id is `903c419ee7ebb6bf4687c61fb133d233ef9db2f80e4d734db3fbaf0b` and we can [view it on Cardanoscan](https://preprod.cardanoscan.io/tokenPolicy/903c419ee7ebb6bf4687c61fb133d233ef9db2f80e4d734db3fbaf0b). Notice how these tokens are minted in ***pairs***.

The token in your wallet has the name `222ppbl2024-<YOUR ALIAS>`. The token at the validator address has the name `100ppbl2024-<YOUR ALIAS>`. We can also [view this validator address on Cardanoscan](https://preprod.cardanoscan.io/address/700b15df07f20ddfded295f947be2d2d4d0b98b55bcf79ff6151b5ea6f).

The validator address was generated by following two steps:
1. Compiling `ContributorToken.Validator` (a process that was introduced in Module 101).
2. Using `cardano-cli address build --testnet-magic 1 --payment-script-file ppbl-contrib-token-validator.plutus` to generate an address (which is similar to the process introduced in Lesson 102.1).

These outputs can be found [in the Plutus Examples `output` directory](https://github.com/gimbalabs/ppbl2024-plutus-examples/tree/main/output).

## What does the validator allow us to do?

The contributor token validator allows the holder of a `222` token to change the datum associated with the `100` token. [You can view the source code for this validator in the PPBL 2024 Plutus Examples Repo](https://github.com/gimbalabs/ppbl2024-plutus-examples/tree/main/src/ContributorToken).

The redeemer in `ContributorToken.Validator` is a `ContributorReferenceAction` that is defined like this:

```haskell
data ContributorReferenceAction = UpdateNumber Integer | UpdateInfo BuiltinByteString | AddCollaborator BuiltinByteString
  deriving (Show)

PlutusTx.makeIsDataIndexed ''ContributorReferenceAction [('UpdateNumber, 0), ('UpdateInfo, 1), ('AddCollaborator, 2)]
PlutusTx.makeLift ''ContributorReferenceAction
```

There are three possible actions:
- `UpdateNumber`
- `UpdateInfo`
- `AddCollaborator`

In this assignment, your task is to change the "Lucky Number" associated with your PPBL 2024 token. You will use the `UpdateNumber` action to complete this task. (After you are successful, you can optionally try to change your `personalInfo` by using the `UpdateInfo` action.)

## What does the datum look like?

In the PlutusTx source code, `ContributorReferenceDatum` is defined like this:

```haskell
data ContributorReferenceDatum = ContributorReferenceDatum
  { luckyNumber    :: !Integer,
    personalInfo   :: !BuiltinByteString,
    collaborator   :: !BuiltinByteString
  }
```

On the blockchain, the corresponding `ContributorReferenceDatum` looks like this:
```json
{
    "constructor": 0,
    "fields": [
        {
            "int": 2024
        },
        {
            "bytes": "696e666f"
        },
        {
            "bytes": ""
        }
    ]
}
```

## Your Assignment

Now it's your turn to build a valid transaction that unlocks a UTxO from the Contributor Reference Validaton and "re-locks" a new UTxO with updated datum. Below, we will share an outline of the steps to complete, but this document will a little bit "less helpful" than before. If you need help, refer back to lessons 102.3, 102.4, and 102.5. If you get stuck, drop by at PPBL Live Coding and we will support you on the journey!

## Here is the transaction:

```bash
cardano-cli transaction build \
--babbage-era \
--testnet-magic 1 \
--tx-in $tx_in_fees \
--tx-in $tx_in_ppbl2024 \
--tx-in-collateral $tx_in_fees \
--tx-in $contributor_reference_validator_tx_in \
--spending-tx-in-reference $ref_utxo \
--spending-plutus-script-v2 \
--spending-reference-tx-in-inline-datum-present \
--spending-reference-tx-in-redeemer-file my-redeemer.json \
--tx-out $sender+"2000000 + 1 $ppbl_2024_policyid.$ppbl_token_222_name" \
--tx-out $contrib_ref_validator_addr+"$lovelace_in_ref_utxo + 1 $ppbl_2024_policyid.$ppbl_token_100_name" \
--tx-out-inline-datum-file my-updated-datum.json \
--change-address $sender \
--out-file change-lucky-number-tx.draft
```

As you can see, there are several variables in this transaction build. You must correctly define each of the missing variables.

Here are some variables to get you started. You will not need to change these:
```bash
ref_utxo=5bc91c8a2f806cae411b32e304bd41770f879b43f0b83d31e02f1bec40cd5f1e#0
contrib_ref_validator_addr=addr_test1wq93thc87gxalhkjjhu5003d94xshx94t08hnlmp2x675mctnrx8v
ppbl_2024_policyid=903c419ee7ebb6bf4687c61fb133d233ef9db2f80e4d734db3fbaf0b
```

It's up to you to define the rest of the variables and build a valid transaction.


### Prepare the Redeemer:
You will also notice that there are two files referenced in this transaction: `my-redeemer.json` and `my-updated-datum.json`. The names of these files do not really matter. You must create each file with the right contents.

Create a new file called `my-redeemer.json`. Then copy and paste these contents inside:
```json
{
    "constructor": 0,
    "fields": [
        { "int": 2024 } // change this number
    ]
}
```
> Note: be sure the remove the "change this number" comment. Comments are not allowed in JSON files.

See the `2024`? ***Your assignment is to change this number to any other number you want***.

### Prepare the updated Datum:
Now create a new file called `my-updated-datum.json`, and paste these contents inside:
```json
{
    "constructor": 0,
    "fields": [
        {
            "int": 2024 // change this number
        },
        {
            "bytes": "696e666f"
        },
        {
            "bytes": ""
        }
    ]
}
```

In order to build a valid transaction, you must satisfy these rules:
```haskell
(UpdateNumber num) ->
      let
        requiredDatum = ContributorReferenceDatum {
          luckyNumber = num,
          personalInfo = personalInfo datum,
          collaborator = collaborator datum
        }

        checkUpdatedDatum :: Bool
        checkUpdatedDatum = case newReferenceDatum of
          Nothing -> False
          Just d -> d == requiredDatum

      in
        traceIfFalse "Contributor and reference tokens do not match"    inputHasContributorRefTokenPair &&
        traceIfFalse "New datum is not valid"                           checkUpdatedDatum
```

These two lines are important:
```haskell
personalInfo = personalInfo datum,
collaborator = collaborator datum
```

These lines say that in the new datum, `personalInfo` and `collaborator` must match their values from the input datum. In other words, you cannot change these values in this transaction.

However, you ***can*** change the `luckyNumber`. As long as the lucky number matches the one you included in `my-redeemer.json`, your transaction will validate.


### Selecting YOUR Contributor Reference UTxO:
There is one more rule you must follow: `inputHasContributorRefTokenPair`. This rule checks to see that the `100` and `222` have the same name (after the 100 or 222 prefix), and that both tokens are included in the transaction.

You must find the `contributor_reference_validator_tx_in` that holds your `100` token. Think about some of the tools you have seen so far. How will you find the transaction hash and index of the relevant UTxO?

### After you build the transaction, then sign and submit it:
```bash
cardano-cli transaction sign \
--signing-key-file $sender_key \
--testnet-magic 1 \
--tx-body-file change-lucky-number-tx.draft \
--out-file change-lucky-number-tx.signed

cardano-cli transaction submit \
--tx-file change-lucky-number-tx.signed \
--testnet-magic 1
```


### Hints:
Here is an example of what the UTxO in your wallet might look like:
```bash
6e7f184a000651329c3a475eea956bb220dc51c846bb306711008695b6a0e8ab     1        2000000 lovelace + 1 903c419ee7ebb6bf4687c61fb133d233ef9db2f80e4d734db3fbaf0b.3232327070626c323032342d64656d6f33 + TxOutDatumNone
```

Notice that there is 1 native asset in this UTxO.
- It has the policy id `903c419ee7ebb6bf4687c61fb133d233ef9db2f80e4d734db3fbaf0b`, which is correct.
- It has the token name `3232327070626c323032342d64656d6f33` which is the hex string representation of `222ppbl2024-demo3`.
- You can use a web site like [Code Beautify](https://codebeautify.org/hex-string-converter) to encode and decode hex strings.
- In this case, we are looking for a token with the name `100ppbl2024-demo3` at the address `addr_test1wq93thc87gxalhkjjhu5003d94xshx94t08hnlmp2x675mctnrx8v`.


## You will know you are successful if:
- The datum associated with your token has a lucky number that is not `2024`.
- In Module 201, we will build a front end dashboard where you can check your lucky number.

## Optional Challenge
Want to keep going? Use what you learned in this lesson to change your on-chain `personalInfo`.